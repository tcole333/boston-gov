#!/bin/bash
# citation-verification - P0 Critical
# Verifies regulatory facts have required citation fields

set -euo pipefail
export LC_ALL=C

# Parse hook input (JSON on stdin)
INPUT=$(cat)

# Extract file path
FILE_PATH=$(echo "$INPUT" | grep -o '"file_path":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")

# Only check files in docs/facts/*.yaml
if [[ ! "$FILE_PATH" =~ docs/facts/.*\.yaml$ ]] && [[ ! "$FILE_PATH" =~ docs/facts/.*\.yml$ ]]; then
  cat <<EOF
{
  "allowed": true
}
EOF
  exit 0
fi

# Skip if file doesn't exist
if [ ! -f "$FILE_PATH" ]; then
  cat <<EOF
{
  "allowed": true
}
EOF
  exit 0
fi

# Required citation fields
REQUIRED_FIELDS=(
  "source_url"
  "last_verified"
  "confidence"
)

# Check for required fields
MISSING_FIELDS=()

for field in "${REQUIRED_FIELDS[@]}"; do
  if ! grep -q "^[[:space:]]*${field}:" "$FILE_PATH" 2>/dev/null; then
    MISSING_FIELDS+=("$field")
  fi
done

# Validate last_verified format (YYYY-MM-DD)
if grep -q "^[[:space:]]*last_verified:" "$FILE_PATH" 2>/dev/null; then
  LAST_VERIFIED=$(grep "^[[:space:]]*last_verified:" "$FILE_PATH" | head -1 | sed 's/.*last_verified:[[:space:]]*["'\'']\?//' | sed 's/["'\''"].*//')
  if ! echo "$LAST_VERIFIED" | grep -qE "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"; then
    MISSING_FIELDS+=("last_verified (invalid format, must be YYYY-MM-DD)")
  fi
fi

# Validate confidence values
if grep -q "^[[:space:]]*confidence:" "$FILE_PATH" 2>/dev/null; then
  CONFIDENCE=$(grep "^[[:space:]]*confidence:" "$FILE_PATH" | head -1 | sed 's/.*confidence:[[:space:]]*["'\'']\?//' | sed 's/["'\''"].*//')
  if [[ ! "$CONFIDENCE" =~ ^(high|medium|low)$ ]]; then
    MISSING_FIELDS+=("confidence (must be: high, medium, or low)")
  fi
fi

# Block if missing required fields
if [ ${#MISSING_FIELDS[@]} -gt 0 ]; then
  BASENAME=$(basename "$FILE_PATH")
  MISSING_LIST=$(printf '  - %s\n' "${MISSING_FIELDS[@]}")

  cat <<EOF
{
  "allowed": false,
  "message": "ðŸš¨ BLOCKED: Missing required citation fields in '$BASENAME'\n\nâš ï¸  Missing or invalid fields:\n$MISSING_LIST\n\nðŸ“– Required citation format for regulatory facts:\n\nsource_url: https://www.boston.gov/...\nsource_section: 'Section name or heading'\nlast_verified: 2025-11-09\nconfidence: high  # or medium, low\n\nâœ… What to do:\n  1. Add all required citation fields\n  2. Verify last_verified uses YYYY-MM-DD format\n  3. Set confidence to: high, medium, or low\n  4. Include source_url pointing to official documentation\n\nðŸ“– See docs/architecture.md for citation requirements."
}
EOF
  exit 0
fi

# Allow if all required fields present
cat <<EOF
{
  "allowed": true
}
EOF
