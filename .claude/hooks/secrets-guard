#!/bin/bash
# secrets-guard - P0 Critical
# Prevents committing secrets and sensitive files

set -euo pipefail
export LC_ALL=C

# Parse hook input (JSON on stdin)
INPUT=$(cat)

# Extract file paths from the input
FILE_PATH=$(echo "$INPUT" | grep -o '"file_path":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
CONTENT=$(echo "$INPUT" | grep -o '"content":"[^"]*"' | head -1 || echo "")

# Protected file patterns
PROTECTED_FILES=(
  ".env"
  ".env.local"
  ".env.production"
  "credentials.json"
  "*.pem"
  "*.key"
  "*.cert"
  "secrets.yaml"
  "secrets.json"
)

# Check if file path matches protected patterns
if [ -n "$FILE_PATH" ]; then
  BASENAME=$(basename "$FILE_PATH")

  for pattern in "${PROTECTED_FILES[@]}"; do
    # Simple pattern matching
    if [[ "$BASENAME" == $pattern ]]; then
      cat <<EOF
{
  "allowed": false,
  "message": "ðŸš¨ BLOCKED: Cannot commit sensitive file '$BASENAME'\n\nâš ï¸  This file appears to contain secrets or credentials.\n\nâœ… What to do:\n  1. Add '$BASENAME' to .gitignore\n  2. Use environment variables instead\n  3. Store secrets in a secure vault\n  4. Never commit files matching: ${PROTECTED_FILES[*]}\n\nðŸ“– See docs/security.md for secure secret management."
}
EOF
      exit 0
    fi
  done
fi

# Detect API keys, tokens, and secrets in content using regex patterns
SECRET_PATTERNS=(
  "AKIA[0-9A-Z]{16}"                    # AWS Access Key
  "sk-[a-zA-Z0-9]{32,}"                 # OpenAI/Stripe API keys
  "['\"]password['\"]\\s*[:=]\\s*['\"][^'\"]{8,}"  # Password assignments
  "['\"]api_key['\"]\\s*[:=]\\s*['\"][^'\"]{16,}"  # API key assignments
  "['\"]secret['\"]\\s*[:=]\\s*['\"][^'\"]{16,}"   # Secret assignments
  "Bearer\\s+[a-zA-Z0-9._-]{32,}"       # Bearer tokens
  "ghp_[a-zA-Z0-9]{36}"                 # GitHub Personal Access Token
  "gho_[a-zA-Z0-9]{36}"                 # GitHub OAuth Token
)

if [ -n "$FILE_PATH" ] && [ -f "$FILE_PATH" ]; then
  for pattern in "${SECRET_PATTERNS[@]}"; do
    if grep -qE "$pattern" "$FILE_PATH" 2>/dev/null; then
      cat <<EOF
{
  "allowed": false,
  "message": "ðŸš¨ BLOCKED: Potential secret detected in '$FILE_PATH'\n\nâš ï¸  Found pattern matching: $pattern\n\nâœ… What to do:\n  1. Remove the secret from the file\n  2. Use environment variables: os.getenv('API_KEY')\n  3. Add the file to .gitignore if it contains secrets\n  4. Rotate any exposed credentials immediately\n\nðŸ“– Never commit API keys, passwords, or tokens to git."
}
EOF
      exit 0
    fi
  done
fi

# Allow if no secrets detected
cat <<EOF
{
  "allowed": true
}
EOF
